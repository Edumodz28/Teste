local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

local MaxDistance = 50  -- Distância máxima para procurar NPCs
local AttackRange = 10  -- Distância máxima para atacar NPCs

-- Função para obter partes visíveis no campo de visão do jogador
local function getPartsInViewport(maxDistance)
    local partsInViewport = {}
    for _, part in ipairs(workspace:GetDescendants()) do
        if part:IsA("BasePart") then
            local distance = LocalPlayer:DistanceFromCharacter(part.Position)
            if distance <= maxDistance then
                local _, isVisible = Camera:WorldToViewportPoint(part.Position)
                if isVisible then
                    table.insert(partsInViewport, part)
                end
            end
        end
    end
    return partsInViewport
end

-- Função para teleportar o jogador para cima do NPC
local function teleportToNPC(npc)
    local humanoidRootPart = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if humanoidRootPart then
        humanoidRootPart.CFrame = CFrame.new(npc.Position + Vector3.new(0, 10, 0))  -- Teleporta 10 metros acima do NPC
    end
end

-- Loop principal para detectar e atacar NPCs próximos
while true do
    wait()  -- Aguarda um intervalo de tempo antes de verificar novamente
    
    local Tool = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Tool")
    
    -- Verifica se o jogador tem uma ferramenta equipada
    if Tool and Tool:FindFirstChild("Handle") then
        -- Obtem todas as partes visíveis no campo de visão dentro do limite de distância
        local Parts = getPartsInViewport(MaxDistance)
        
        -- Loop através das partes visíveis no campo de visão
        for _, Part in ipairs(Parts) do
            -- Verifica se a parte pertence a um personagem e se o personagem está vivo
            if Part and Part.Parent and Part.Parent ~= LocalPlayer.Character and Part.Parent:FindFirstChild("Humanoid") and Part.Parent.Humanoid.Health > 0 then
                -- Verifica se o NPC está dentro do alcance de ataque
                local distanceToNPC = LocalPlayer:DistanceFromCharacter(Part.Position)
                if distanceToNPC <= AttackRange then
                    -- Teleporta o jogador para cima do NPC
                    teleportToNPC(Part)
                    
                    -- Ativa a ferramenta e ataca a parte
                    Tool:Activate()
                    game:GetService("ReplicatedStorage").MeleeEvent:FireServer(Part)
                    
                    -- Aguarda até que a vida do NPC seja menor ou igual a 0 (ou seja, o NPC morreu)
                    while Part.Parent:FindFirstChild("Humanoid") and Part.Parent.Humanoid.Health > 0 do
                        wait()
                    end
                    
                    -- Procura pelo próximo NPC
                    break
                end
            end
        end
    end
end
